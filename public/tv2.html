<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Layout centr√© - Live Chat IRL</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
</head>
<body class="tv-centered">
  <div id="wall"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const wall = document.getElementById('wall');

    // Append element and scroll to bottom to ensure newest messages are visible.
    function appendWithLimit(el) {
      wall.appendChild(el);

      // ensure newest visible
      wall.scrollTop = wall.scrollHeight;

      // enforce max 20 items
      while (wall.children.length > 20) {
        const first = wall.firstElementChild;
        if (!first) break;
        if (first._removeTimeout) clearTimeout(first._removeTimeout);
        wall.removeChild(first);
      }
    }

    socket.on('message', msg => {
      // Build a container for text+media, or a single message for text-only
      if (msg.type === 'text') {
        const el = document.createElement('div');
        el.className = 'message';
        el.textContent = msg.content;
        appendWithLimit(el);
        return;
      }

      // for media messages build .item container and append accordingly
      if (msg.type === 'image') {
        const container = document.createElement('div');
        container.className = 'item';
        if (msg.text) {
          const t = document.createElement('div');
          t.className = 'message';
          t.textContent = msg.text;
          container.appendChild(t);
        }

        const img = document.createElement('img');
        img.className = 'image';

        img.onload = () => {
          container.appendChild(img);
          appendWithLimit(container);
        };
        img.onerror = () => {
          if (msg.text) appendWithLimit(container);
          else console.warn('Image failed to load, skipping:', msg.content);
        };

        img.src = msg.content;
        return;
      }

      if (msg.type === 'youtube') {
        const container = document.createElement('div');
        container.className = 'item';
        if (msg.text) {
          const t = document.createElement('div');
          t.className = 'message';
          t.textContent = msg.text;
          container.appendChild(t);
        }

        const iframe = document.createElement('iframe');
        if (msg.vertical === true) {
          iframe.width = '360'; iframe.height = '640';
        } else {
          iframe.width = '640'; iframe.height = '360';
        }
        iframe.src = `https://www.youtube.com/embed/${msg.content}?autoplay=1&mute=1&controls=0&modestbranding=1&rel=0&playlist=${msg.content}&loop=1`;
        iframe.allow = 'autoplay; encrypted-media';
        iframe.className = 'image';
        container.appendChild(iframe);
        appendWithLimit(container);
        return;
      }
    });
  </script>
</body>
</html>
