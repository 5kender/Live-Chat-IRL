<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Layout random - Live Chat IRL</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="tv">
  <div id="wall"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const wall = document.getElementById("wall");

    // append element, place it at a random position fully inside #wall,
    // enforce max 10 items and remove each after 30s
    function appendWithLimitPosition(el) {
      // prepare for measurement
      el.style.position = 'absolute';
      el.style.visibility = 'hidden';
      wall.appendChild(el);

      // measure sizes
      const wallW = wall.clientWidth;
      const wallH = wall.clientHeight;
      const elW = el.offsetWidth;
      const elH = el.offsetHeight;

      const maxLeft = Math.max(0, wallW - elW);
      const maxTop = Math.max(0, wallH - elH);

      const left = Math.floor(Math.random() * (maxLeft + 1));
      const top = Math.floor(Math.random() * (maxTop + 1));

      el.style.left = left + 'px';
      el.style.top = top + 'px';
      el.style.visibility = 'visible';
    }

    socket.on("message", (msg) => {
        // If message contains media and optional text, render text above media in one container.
        // If it's text-only, keep previous behavior.

        // TEXT-ONLY
        if (msg.type === "text") {
          const el = document.createElement("div");
          el.className = "message";
          el.textContent = msg.content;
          appendWithLimitPosition(el);
        }

        // IMAGE (may include msg.text)
        if (msg.type === "image") {
          const container = document.createElement('div');
          // if there's text, render it above the image
          if (msg.text) {
            const t = document.createElement('div');
            t.className = 'message';
            t.textContent = msg.text;
            container.appendChild(t);
          }

          const img = document.createElement("img");
          img.className = "image";

          img.onload = () => {
            container.appendChild(img);
            appendWithLimitPosition(container);
          };

          img.onerror = () => {
            if (msg.text) appendWithLimitPosition(container);
            else console.warn('Image failed to load, skipping display:', msg.content);
          };

          img.src = msg.content;
        }

        // YOUTUBE (may include msg.text)
        if (msg.type === "youtube") {
          const container = document.createElement('div');
          if (msg.text) {
            const t = document.createElement('div');
            t.className = 'message';
            t.textContent = msg.text;
            container.appendChild(t);
          }

          const iframe = document.createElement("iframe");

          // taille comme les images selon si c'est un short ou pas
          console.log("msg.vertical", msg.vertical);
          if (msg.vertical === true) {
            iframe.width = "180"; // ou adapte selon ton CSS
            iframe.height = "320"; // ratio 9:16
          } else {
            iframe.width = "320"; // ou adapte selon ton CSS
            iframe.height = "180"; // ratio 16:9
          }

          iframe.src = `https://www.youtube.com/embed/${msg.content}?autoplay=1&mute=1&controls=0&modestbranding=1&rel=0&playlist=${msg.content}&loop=1`;
          iframe.allow = "autoplay; encrypted-media";
          iframe.style.border = "none";
          iframe.style.margin = "10px";
          iframe.style.borderRadius = "8px";
          iframe.className = "image"; // pour r√©utiliser le style image

          container.appendChild(iframe);
          appendWithLimitPosition(container);
        }

    });
  </script>
</body>
</html>
